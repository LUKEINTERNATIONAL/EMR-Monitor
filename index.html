<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>EMR-Monitor</title>

  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="plugins/fontawesome-free/css/all.min.css">
  <!-- Ionicons -->
  <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
  <!-- Tempusdominus Bootstrap 4 -->
  <link rel="stylesheet" href="plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css">
  <!-- iCheck -->
  <link rel="stylesheet" href="plugins/icheck-bootstrap/icheck-bootstrap.min.css">
  <!-- JQVMap -->
  <link rel="stylesheet" href="plugins/jqvmap/jqvmap.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="dist/css/adminlte.min.css">
  <!-- overlayScrollbars -->
  <link rel="stylesheet" href="plugins/overlayScrollbars/css/OverlayScrollbars.min.css">
  <!-- Daterange picker -->
  <link rel="stylesheet" href="plugins/daterangepicker/daterangepicker.css">
  <!-- summernote -->
  <link rel="stylesheet" href="plugins/summernote/summernote-bs4.min.css">
  <style>
    .checkbox-green::before {
      background: #20c997;
    }
    .checkbox-red::before {
      background: #e74c3c;
    }
    .small-box p {
    font-size: 1.2rem;
    }
    .inner_vpn{
        position:relative;
        top:0px;
    }
    .outer_vpn{
        overflow:hidden;
    }
  </style>
</head>
<body class="hold-transition sidebar-mini layout-fixed">
<div class="wrapper">

  <!-- bars plus loader -->
  <app-bars></app-bars>

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <div class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1 class="m-0">Dashboard</h1>
          </div><!-- /.col -->
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item"><a href="#">Home</a></li>
              <li class="breadcrumb-item active">Dashboard v1</li>
            </ol>
          </div><!-- /.col -->
        </div><!-- /.row -->
      </div><!-- /.container-fluid -->
    </div>
    <!-- /.content-header -->

    <!-- Main content -->
    <section class="content">
      <div class="container-fluid">
        <!-- Small boxes (Stat box) -->
        <div class="row">
          <div class="col-lg-3 col-6">
            <!-- small box -->
            <div class="small-box bg-info">
              <div class="inner">
                <h3 id="user_count">...</h3>
                <p>Total Users</p>
              </div>
              <div class="icon">
                <i class="ion ion-person-add"></i>
              </div>
              <a href="/pages/manage_users.html" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
            </div>
          </div>
          <!-- ./col -->
          <div class="col-lg-3 col-6">
            <!-- small box -->
            <div class="small-box bg-success">
              <div class="inner">
                <h3 id="facilities_count">...</h3>

                <p>Total Facilities</p>
              </div>
              <div class="icon">
                <i class="ion ion-stats-bars"></i>
              </div>
              <a href="/pages/manage_facilities.html" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
            </div>
          </div>
          <!-- ./col -->
          <div class="col-lg-3 col-6">
            <!-- small box -->
            <div class="small-box bg-danger">
              <div class="inner">
                <h3 id="inactive_vpn_count">...</h3>

                <p>Total Inactive VPN</p>
              </div>
              <div class="icon">
                <i class="ion ion-stats-bars"></i>
              </div>
              <a href="/pages/manage_facilities.html" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
            </div>
          </div>
          <!-- ./col -->
          <div class="col-lg-3 col-6">
            <!-- small box -->
            <div class="small-box bg-warning">
              <div class="inner">
                <h3 id="encounters_count">...</h3>

                <p id="bargraph_card">Total Encounters</p>
              </div>
              <div class="icon">
                <i class="ion  ion-stats-bars"></i>
              </div>
              <a href="#" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
            </div>
          </div>
        </div>
        <!-- /.row -->
        <!-- Main row -->
        <div class="row">
          <!-- Left col -->
          <section class="col-lg-9 connectedSortable">
             <!-- BAR CHART -->
             <div class="card">
              <div class="card-header">
                <h3 class="card-title" id="bargraph_title">Encounters</h3>

                <div class="card-tools">
                  <ul class="pagination pagination-sm" id="pages_btn_set">
                    <li class="page-item"><a class="page-link" onclick="setpage_chart(chart_setting.currentPage-1)">&laquo;</a></li>
                    <li class="page-item"><a class="page-link" onclick="setpage_chart(1)">1</a></li>
                    <li class="page-item"><a class="page-link" onclick="setpage_chart(chart_setting.currentPage+1)">&raquo;</a></li>
                  </ul>
                </div>
              </div>
              <div class="card-body">
                <div class="chart" id="chart_set">
                  <canvas id="barChart1" style="min-height: 59vh; height: 59vh; max-height: 59vh; max-width: 100%;"></canvas>
                </div>
              </div>
              <!-- /.card-body -->
            </div>
            <!-- /.card -->

          </section>
          <!-- /.Left col -->
          <!-- right col (We are only adding the ID to make the widgets sortable)-->
          <section class="col-lg-3 connectedSortable">

             <!-- TO DO List -->
             <div class="card">
              <div class="card-header">
                <h3 class="card-title">
                  <i class="ion ion-clipboard mr-1"></i>
                  VPN Status
                </h3>

                <div class="card-tools">
                  <ul class="pagination pagination-sm" id="vpn_pages_btn_set">
                    <li class="page-item"><a class="page-link" onclick="setpage_vpn(vpn_setting.currentPage-1)">&laquo;</a></li>
                    <li class="page-item"><a class="page-link" onclick="setpage_vpn(1)">1</a></li>
                    <li class="page-item"><a class="page-link" onclick="setpage_vpn(vpn_setting.currentPage+1)">&raquo;</a></li>
                  </ul>
                </div>
              </div>
              <!-- /.card-header -->
              <div class="outer_vpn" id="outer_vpn" style="height: 63vh;">
                <ul class="todo-list inner_vpn" data-widget="todo-list" id="vpn_list" style="overflow:unset; min-height: 63.5vh; height: 63.5vh; max-height: 63.5vh; max-width: 100%;">
                  
                </ul>
              </div>
            
            <!-- /.card -->

          </section>
          <!-- right col -->
        </div>
        <!-- /.row (main row) -->
      </div><!-- /.container-fluid -->
    </section>
    <!-- /.content -->
  </div>
  <!-- /.content-wrapper -->
  <app-footer></app-footer>

  <!-- Control Sidebar -->
  <aside class="control-sidebar control-sidebar-dark">
    <!-- Control sidebar content goes here -->
  </aside>
  <!-- /.control-sidebar -->
</div>
<!-- ./wrapper -->
<script src="components/bars.js"></script>

<!-- jQuery -->
<script src="plugins/jquery/jquery.min.js"></script>
<!-- jQuery UI 1.11.4 -->
<script src="plugins/jquery-ui/jquery-ui.min.js"></script>
<!-- Resolve conflict in jQuery UI tooltip with Bootstrap tooltip -->
<script>
  $.widget.bridge('uibutton', $.ui.button)
</script>
<!-- Bootstrap 4 -->
<script src="plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- ChartJS -->
<script src="plugins/chart.js/Chart.js"></script>
<!-- Sparkline -->
<script src="plugins/sparklines/sparkline.js"></script>
<!-- JQVMap -->
<script src="plugins/jqvmap/jquery.vmap.min.js"></script>
<script src="plugins/jqvmap/maps/jquery.vmap.usa.js"></script>
<!-- jQuery Knob Chart -->
<script src="plugins/jquery-knob/jquery.knob.min.js"></script>
<!-- daterangepicker -->
<script src="plugins/moment/moment.min.js"></script>
<script src="plugins/daterangepicker/daterangepicker.js"></script>
<!-- Tempusdominus Bootstrap 4 -->
<script src="plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js"></script>
<!-- Summernote -->
<script src="plugins/summernote/summernote-bs4.min.js"></script>
<!-- overlayScrollbars -->
<script src="plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js"></script>
<!-- AdminLTE App -->
<script src="dist/js/adminlte.js"></script>
<!-- AdminLTE for demo purposes -->
<script src="dist/js/demo.js"></script>
<!-- AdminLTE dashboard demo (This is only for demo purposes) -->
<!-- <script src="dist/js/pages/dashboard.js"></script> -->
<script src="dist/js/backend.js"></script>

<script>

  var chart_setting = {
    cur_dataset: undefined,
    cur_datawrapper: undefined,
    cur_label: undefined,
    pageNum: 1,
    currentPage: 1
  };
  const paginationLimit = 5;
  var vpn_setting = {
    data: undefined,
    pageNum: 1,
    currentPage: 1
  };

  // function process_vpn_data(data){
    // vpn_setting.pageNum = Math.ceil(data.vpn.length / paginationLimit);
    // if(vpn_setting.currentPage > vpn_setting.pageNum) vpn_setting.currentPage = 1;
    // vpn_setting.data = data.vpn;
    // var vpn = data.vpn.filter((el) => el.vpn_status == "inactive")
    // $("#inactive_vpn_count").text(vpn.length)
    // setpage_vpn(vpn_setting.currentPage);
  // }

  function random_rgba(program_name) {
    var o = Math.round, r = Math.random, s = 255;
    var R = 256, G = 256, B = 256;
    while(R+G+B > 600){
      R = o(r()*s)
      G = o(r()*s)
      B = o(r()*s)
    }
    var opacity = r().toFixed(1)
    if(program_name == "HIV PROGRAM")
      return "rgba( 47, 79, 79, 0.7)"
    if(program_name == "OPD Program")
      return "rgba(72, 61, 139, 0.7)"
    if(program_name == "ANC PROGRAM")
      return "rgba(255, 20, 147, 0.7)"
    if(program_name == "CxCa program")
      return "rgba(0, 191, 255, 0.7)"
    else
    if (opacity < 0.5) opacity += 0.5
    return 'rgba(' + R + ',' + G + ',' + B + ',' + opacity + ')';
  }

  function bargraph_switcher(){
    if(sessionStorage.getItem('bargraph_status') !== null)
      if(sessionStorage.getItem('bargraph_status') == 'false')
      status = 'true'
      else
      status = 'false'
    else
      status = 'true'

    sessionStorage.setItem('bargraph_status',status);
  }
  function process_encounter_data(data){
    bargraph_switcher()
    datasets = []
    // $("#encounters_count").text(data.facilities.length === undefined? 0: data.facilities.length)
    if(sessionStorage.getItem('bargraph_status') == 'false'){
      var total_encounters = 0;
      data.facilities.forEach(x => {n = parseInt(x.total_encounters); total_encounters += isNaN(n) ? 0 : n;})
      $("#encounters_count").text(total_encounters);
      $("#bargraph_title").text("Encounters")
      $("#bargraph_card").text("Total Encounters")
    }else{
      var total_patients = 0;
      data.facilities.forEach(x => {n = parseInt(x.total_patients); total_patients += isNaN(n) ? 0 : n;})
      $("#encounters_count").text(total_patients);
      $("#bargraph_title").text("Patients")
      $("#bargraph_card").text("Total Patients")
    }

    const unique_programs = [...new Set(data.facilities.map(item => item.program_name))];
    const unique_labels = [...new Set(data.facilities.map(item => item.facility_name))];

    encounter_data = []
    for(const [i, program] of unique_programs.entries()){
      encounter_data.push([])
      for(facility_name in unique_labels){
          var encounter_value = data.facilities.filter((el) => el.program_name == program && el.facility_name == unique_labels[facility_name] )
          if(encounter_value.length > 0)
            if(sessionStorage.getItem('bargraph_status') == 'false')
              encounter_data[i].push(parseInt(encounter_value[0].total_encounters))
            else
              encounter_data[i].push(parseInt(encounter_value[0].total_patients))
          else
          encounter_data[i].push(0)
      }
      
      graphic= {
          label               : program,
          backgroundColor     : random_rgba(program),
          borderColor         : random_rgba(program),
          pointRadius          : false,
          pointColor          : '#3b8bba',
          pointStrokeColor    : 'rgba(60,141,188,1)',
          pointHighlightFill  : '#fff',
          pointHighlightStroke: 'rgba(60,141,188,1)',
          data                : [],
        }
        datasets.push(graphic)
    }
    
    chart_setting.cur_datawrapper = datasets;
    chart_setting.cur_dataset = encounter_data;
    chart_setting.cur_label = unique_labels;
    chart_setting.pageNum = Math.ceil(unique_labels.length / paginationLimit);
    if(chart_setting.currentPage > chart_setting.pageNum) chart_setting.currentPage = 1;
    console.log(datasets)
    setpage_chart(chart_setting.currentPage);
    graphs();
  }

  function setpage_chart(num) {
    $("#barChart" + chart_setting.currentPage).attr("hidden", true)
    chart_setting.currentPage = num;
    if(chart_setting.currentPage == 0) chart_setting.currentPage = chart_setting.pageNum;
    if(chart_setting.currentPage > chart_setting.pageNum) chart_setting.currentPage = 1;
    $("#barChart" + chart_setting.currentPage).removeAttr("hidden")

    var from = chart_setting.currentPage-3 > 1 ? chart_setting.currentPage-3 : 1;
    var to = chart_setting.currentPage+3 < chart_setting.pageNum ?
             chart_setting.currentPage+3 : chart_setting.pageNum;
    
    var html_str = '<li class="page-item"><a class="page-link" onclick="setpage_chart(chart_setting.currentPage-1)">&laquo;</a></li>'
    for(let i = from; i <= to; i++) {
      html_str += '<li class="page-item"><a class="page-link"' + 
                  ' onclick="setpage_chart(' + i + ')">' + i + '</a></li>';
    }
    html_str += '<li class="page-item"><a class="page-link" onclick="setpage_chart(chart_setting.currentPage+1)" id="next_btn">&raquo;</a></li>'
    $("#pages_btn_set").html(html_str);
  }

  function min(a, b) {
    return a>b ? b : a;
  }

  function process_vpn_data(data) {
    var li = ""
    data = data.vpn
    var vpn = data.filter((el) => el.vpn_status == "inactive")
    $("#inactive_vpn_count").text(vpn.length)
    for(item in data ){
      console.log(data[item].vpn_status)
      // console.log(data.vpn[item].facility_name)
      if(data[item].vpn_status == 'active')
          color = "checkbox-green"
      else
        color = "checkbox-red"

      li += `<li>
              <span class="handle">
                <i class="fas fa-ellipsis-v"></i>
                <i class="fas fa-ellipsis-v"></i>
              </span>
              <div  class="icheck-primary d-inline ml-2">
                <input type="text" value="" name="todo2" id="todoCheck2" checked>
                <label class="${color}"  for="todoCheck2"></label>
              </div>
              <span class="text">${data[item].facility_name}</span>
            </li>`
    }
    $("#vpn_list").html(li)
    
  }

  function graphs() {
    /* ChartJS
     * -------
     * Here we will create a few charts using ChartJS
     */
    for(var cur = 1; cur <= chart_setting.pageNum; cur++) {
      var wrapper = structuredClone(chart_setting.cur_datawrapper)
      for(let i = 0; i < wrapper.length; i++) {
        wrapper[i].data = chart_setting.cur_dataset[i].slice((cur-1)*5, cur*5)
      }
      var areaChartData = {
        labels  : chart_setting.cur_label.slice((cur-1)*5, cur*5),
        datasets: wrapper
      }

      if(cur != 1) {
        $('#chart_set').append('<canvas id="barChart' + cur + '" style="min-height:59vh; height:59vh; max-height:59vh; max-width: 100%;" hidden></canvas>')
      }
      //-------------
      //- BAR CHART -
      //-------------
      var barChartCanvas = $('#barChart' + cur).get(0).getContext('2d')

      var barChartOptions = {
        responsive              : true,
        maintainAspectRatio     : false,
        datasetFill             : false
      }

      // new Chart(barChartCanvas, {
      //   type: 'bar',
      //   data: areaChartData,
      //   options: barChartOptions
      // })

      var UserVsMyApps = new Chart(barChartCanvas, {
        type: 'bar',
        data: areaChartData,
        options: {
            responsive: true,
            legend: {
                position: 'top',
                display: true,
                labels: {
                  fontSize: 14
                }
 
            },
            "hover": {
              "animationDuration": 0
            },
             "animation": {
                "duration": 1,
              "onComplete": function() {
                var chartInstance = this.chart,
                  ctx = chartInstance.ctx;
 
                ctx.font = Chart.helpers.fontString(Chart.defaults.global.defaultFontSize, Chart.defaults.global.defaultFontStyle, Chart.defaults.global.defaultFontFamily);
                ctx.textAlign = 'center';
                ctx.textBaseline = 'bottom';
 
                this.data.datasets.forEach(function(dataset, i) {
                  var meta = chartInstance.controller.getDatasetMeta(i);
                  meta.data.forEach(function(bar, index) {
                    var data = dataset.data[index];
                    ctx.fillText(data, bar._model.x, bar._model.y - 5);
                  });
                });
              }
            },
            title: {
                display: false,
                text: 'Daily EMR Encounters',
            },
            scales: {
              xAxes: [{
                ticks: {
                  beginAtZero: true,
                  fontSize: 15,  
                }
              }],
              yAxes: [{
                display: true
              }]
            }
        }
    });

    }
  }
  function total_users_data(data){$("#user_count").text(data.length)}
  function total_facilities_data(data){$("#facilities_count").text(data.facilities.length)}

  function refresh() {
    getData(base_url+'encounters/list/','process_encounter_data')
    getData(base_url+'vpn/list/','process_vpn_data')
    getData(base_url+'users/','total_users_data')
    getData(base_url+'facilities/list/','total_facilities_data')
    $('.inner_vpn').html("")
  }
  function openFullscreen() {
    var elem =$('body').attr('class','sidebar-collapse')
    if (elem.requestFullscreen) {
      elem.requestFullscreen();
    } else if (elem.webkitRequestFullscreen) { /* Safari */
      elem.webkitRequestFullscreen();
    } else if (elem.msRequestFullscreen) { /* IE11 */
      elem.msRequestFullscreen();
    }
  }
  $(function () {
    document.documentElement.requestFullscreen();
    openFullscreen()
    refresh();
    function autoScrollDown(){
    $(".inner_vpn").css({top:-$(".outer_vpn").outerHeight()}) // jump back
                  .animate({top:0},50000,"linear", autoScrollDown); // and animate
    }
    // fix hight of outer_vpn:
    $('.outer_vpn').css({maxHeight: $('.inner_vpn').height()});
    // duplicate content of inner_vpn:
    $('.inner_vpn').html($('.inner_vpn').html() + $('.inner_vpn').html());
    
    autoScrollDown();

    $('#outer_vpn').attr('style','height: 63vh;')
    setInterval(function() {
      // $('#vpn_list').animate({scrollTop: 8}, 4000);
      $("#next_btn").click();
    }, 60000);

    setInterval(function() {
      refresh();
    }, 200000);
  });
  
</script>
<script>
  document.documentElement.requestFullscreen().catch((e) => {
     console.log(e);
  });
</script>
</body>
</html>


